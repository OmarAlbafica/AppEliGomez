<div *ngIf="!isMobile" class="space-y-6">
  <!-- Mensajes -->
  <div *ngIf="mensaje" 
       [ngClass]="mensaje.tipo === 'éxito' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'"
       class="border rounded px-4 py-3">
    {{ mensaje.texto }}
  </div>

  <!-- Modal: Zoom de Imagen -->
  <div *ngIf="mostrarZoom" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-screen overflow-hidden flex flex-col transition-colors duration-300">
      <div class="flex justify-between items-center p-4 border-b border-gray-300 dark:border-gray-700 transition-colors duration-300">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white transition-colors duration-300">🔍 Vista Ampliada</h3>
        <button (click)="cerrarZoom()" class="text-2xl text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white font-bold transition-colors duration-300">✕</button>
      </div>
      <div class="flex-1 flex items-center justify-center p-4 overflow-auto bg-white dark:bg-gray-900 transition-colors duration-300">
        <img [src]="imagenZoom" alt="Imagen ampliada" class="max-w-full max-h-full object-contain">
      </div>
      <div class="p-4 border-t border-gray-300 dark:border-gray-700 text-center text-sm text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-800 transition-colors duration-300">
        💡 Usa el zoom del navegador (Ctrl + rueda) para ampliar más o haz clic fuera para cerrar
      </div>
    </div>
  </div>

  <!-- Header con gradiente -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 dark:from-blue-800 dark:to-blue-900 text-white rounded-lg p-6 shadow-lg border-b-4 border-blue-800">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">🖼️ Productos</h1>
        <p class="text-blue-100 dark:text-blue-200 text-sm mt-1">Galería de imágenes con códigos automáticos</p>
      </div>
      <button (click)="abrirCargaImagenes()" class="bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200">
        ⬆️ Cargar Imágenes
      </button>
    </div>
  </div>

  <!-- Modal Carga de Imágenes -->
  <div *ngIf="mostrarCargaImagenes" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto flex flex-col transition-colors duration-300">
      <div class="p-8 sticky top-0 bg-white dark:bg-gray-800">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white transition-colors duration-300">⬆️ Cargar Imágenes</h2>
      </div>

      <div class="px-8 pb-8 space-y-4">
        <!-- Nombre del álbum -->
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300 transition-colors duration-300">Album (ej: 20251222 o Meses)</label>
          <input [(ngModel)]="albumNombre" 
                 type="text" 
                 placeholder="20251222 o Meses"
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:text-white transition-colors duration-300">
        </div>

        <!-- Número inicial -->
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300 transition-colors duration-300">Número inicial</label>
          <input [(ngModel)]="numeroInicio" 
                 type="number" 
                 min="1"
                 class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:text-white transition-colors duration-300">
        </div>

        <!-- Selección de archivos -->
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300 transition-colors duration-300">Imágenes</label>
          <input (change)="onFilesSelected($event)" 
                 type="file" 
                 multiple 
                 accept="image/*"
                 class="w-full text-gray-900 dark:text-gray-300">
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 transition-colors duration-300">Seleccionadas: {{ archivosCargados.length }} imagen(es)</p>
          <div *ngIf="archivosCargados.length > 0" class="mt-3 p-2 bg-blue-100 dark:bg-blue-900 dark:bg-opacity-30 rounded text-xs text-blue-800 dark:text-blue-300 transition-colors duration-300 max-h-48 overflow-y-auto">
            <p class="font-bold mb-1">📦 Se comprimira a ~100KB por imagen sin perder calidad notable</p>
            <p class="mt-1" *ngFor="let archivo of archivosCargados">
              • {{ archivo.name }} ({{ (archivo.size / 1024 / 1024).toFixed(2) }}MB)
            </p>
          </div>
        </div>

        <!-- Progreso -->
        <div *ngIf="procesando">
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 transition-colors duration-300">
            <div class="bg-indigo-600 dark:bg-indigo-500 h-2 rounded-full transition-colors duration-300" [style.width.%]="progreso"></div>
          </div>
          <p class="text-xs text-center text-gray-600 dark:text-gray-400 mt-2 transition-colors duration-300">Procesando... {{ progreso }}%</p>
        </div>
      </div>

      <!-- Botones (sticky al final) -->
      <div class="px-8 pb-8 sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 pt-4 flex gap-3">
        <button (click)="procesarCarga()" 
                [disabled]="procesando || archivosCargados.length === 0"
                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold disabled:bg-gray-400 transition">
          {{ procesando ? '⏳ Procesando...' : '✅ Cargar' }}
        </button>
        <button (click)="mostrarCargaImagenes = false" 
                [disabled]="procesando"
                class="flex-1 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-bold disabled:bg-gray-300 transition">
          ✕ Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmar Borrar Álbum -->
  <div *ngIf="mostrarModalBorrar && albumABorrar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
      <h2 class="text-2xl font-bold mb-4 text-red-600">⚠️ Borrar Álbum</h2>
      
      <p class="text-gray-700 dark:text-gray-300 mb-2">¿Estás seguro de que quieres eliminar el álbum?</p>
      <p class="text-xl font-bold text-gray-900 dark:text-white mb-4 p-3 bg-red-50 border-2 border-red-300 rounded-lg">
        "{{ albumABorrar }}"
      </p>
      
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        Se eliminarán <strong>{{ contarProductosDelAlbum(albumABorrar || '') }}</strong> imagen(es) de este álbum.
      </p>

      <div class="flex gap-3">
        <button (click)="borrarAlbum()" 
                [disabled]="borrando"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold disabled:bg-gray-400">
          {{ borrando ? '⏳ Borrando...' : '🗑️ Borrar' }}
        </button>
        <button (click)="cerrarModalBorrar()" 
                [disabled]="borrando"
                class="flex-1 bg-gray-400 hover:bg-gray-50 dark:bg-gray-7000 text-white px-4 py-2 rounded-lg font-bold disabled:bg-gray-300">
          ✕ Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
    <h3 class="text-lg font-bold mb-4">🔍 Filtros y Acciones</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <!-- Filtro por Álbum -->
      <div>
        <label class="block text-sm font-medium mb-2">📚 Álbum</label>
        <select [(ngModel)]="albumSeleccionado" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-600 outline-none">
          <option value="todos">✨ Todos los álbumes</option>
          <option *ngFor="let album of albums" [value]="album">{{ album }}</option>
        </select>
      </div>
      
      <!-- Filtro por Reservado/Disponible -->
      <div>
        <label class="block text-sm font-medium mb-2">📦 Estado</label>
        <select [(ngModel)]="filtroReservado" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-600 outline-none">
          <option value="todos">✨ Todos</option>
          <option value="disponibles">○ Disponibles</option>
          <option value="reservados">● Reservados</option>
        </select>
      </div>
    </div>

    <!-- Botón para eliminar álbum seleccionado -->
    <div *ngIf="albumSeleccionado !== 'todos'" class="mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
      <button (click)="abrirModalBorrarAlbum(albumSeleccionado)"
              class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition">
        🗑️ Eliminar Álbum "{{ albumSeleccionado }}"
      </button>
      <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">Se eliminarán todas las imágenes de este álbum</p>
    </div>
  </div>

  <!-- Galería -->
  <div *ngIf="getProductosFiltrados().length > 0" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
    <div *ngFor="let producto of getProductosFiltrados()" 
         class="bg-white dark:bg-gray-800 rounded-lg shadow hover:shadow-lg transition overflow-hidden relative">
      
      <!-- Badge de Estado -->
      <div class="absolute top-2 left-2 z-10">
        <span [ngClass]="obtenerColorEstado(producto)" 
              class="text-xs font-bold px-2 py-1 rounded-full inline-block">
          {{ obtenerEstadoProducto(producto) }}
        </span>
      </div>
      
      <!-- Imagen -->
      <img [src]="producto.url_thumbnail" 
           alt="{{ producto.codigo }}"
           class="w-full h-56 object-contain cursor-pointer hover:opacity-80 transition bg-gray-50 dark:bg-gray-700"
           (click)="abrirDetalle(producto)">
      
      <!-- Info -->
      <div class="p-3">
        <p class="font-bold text-sm text-gray-900 dark:text-white truncate">{{ producto.codigo }}</p>
        <p class="text-xs text-gray-600 dark:text-gray-400">{{ producto.album }}</p>
        <button (click)="copiarCodigo(producto.codigo)" 
                class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-2 py-1 rounded font-medium transition">
          📋 Copiar
        </button>
      </div>
    </div>
  </div>

  <!-- Sin productos -->
  <div *ngIf="getProductosFiltrados().length === 0" class="bg-yellow-100 border-2 border-yellow-300 rounded-lg p-6 text-center">
    <p class="text-xl text-yellow-900">📭 No hay productos con esos filtros</p>
    <p class="text-gray-600 dark:text-gray-400 mt-2">Cambia los filtros o carga más imágenes</p>
  </div>

  <!-- Estadísticas -->
  <div *ngIf="productos.length > 0" class="bg-blue-50 border border-blue-300 rounded-lg p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <p class="font-semibold text-blue-900">📊 Total de Productos</p>
        <p class="text-lg font-bold text-blue-700">{{ productos.length }}</p>
      </div>
      <div>
        <p class="font-semibold text-blue-900">○ Disponibles</p>
        <p class="text-lg font-bold text-green-600">{{ contarDisponibles() }}</p>
      </div>
      <div>
        <p class="font-semibold text-blue-900">● Reservados</p>
        <p class="text-lg font-bold text-red-600">{{ contarReservados() }}</p>
      </div>
    </div>
    <p class="text-sm text-blue-800 mt-3">Compresión promedio: {{ calcularCompressionPromedio().toFixed(0) }} KB por imagen</p>
  </div>
</div>

<!-- VISTA MOBILE -->
<div *ngIf="isMobile" class="space-y-4 p-3">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">🖼️ Galería</h1>
    <button (click)="abrirCargaImagenes()" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs font-bold">
      ⬆️
    </button>
  </div>

  <div *ngIf="mensaje" 
       [ngClass]="mensaje.tipo === 'éxito' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'"
       class="border rounded px-3 py-2 text-sm">
    {{ mensaje.texto }}
  </div>

  <!-- Stats Compactos -->
  <div *ngIf="productos.length > 0" class="grid grid-cols-3 gap-2 text-center text-sm">
    <div class="bg-blue-50 rounded p-2">
      <p class="text-xs text-gray-600 dark:text-gray-400">Total</p>
      <p class="font-bold text-blue-700">{{ productos.length }}</p>
    </div>
    <div class="bg-green-50 rounded p-2">
      <p class="text-xs text-gray-600 dark:text-gray-400">Libres</p>
      <p class="font-bold text-green-600">{{ contarDisponibles() }}</p>
    </div>
    <div class="bg-red-50 rounded p-2">
      <p class="text-xs text-gray-600 dark:text-gray-400">Usados</p>
      <p class="font-bold text-red-600">{{ contarReservados() }}</p>
    </div>
  </div>

  <!-- Galería (grid-cols-3) -->
  <div class="grid grid-cols-3 gap-2">
    <div *ngFor="let producto of productos" 
         class="relative rounded overflow-hidden border-2 border-gray-300 dark:border-gray-600">
      <img [src]="producto.url_imagen" alt="Producto"
           class="w-full h-24 object-cover cursor-pointer hover:opacity-80">
      <div class="text-center p-1 bg-gray-100 dark:bg-gray-700 text-xs font-bold text-gray-800 dark:text-white">
        {{ producto.codigo }}
      </div>
    </div>
  </div>

  <div *ngIf="productos.length === 0" class="text-center py-8">
    <p class="font-bold text-gray-900 dark:text-white">📭 Sin imágenes</p>
  </div>

  <!-- Modal Zoom Mobile -->
  <div *ngIf="mostrarZoom" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden flex flex-col max-h-screen w-full">
      <div class="flex justify-between items-center p-2 border-b">
        <h3 class="text-lg font-bold">🔍 Ampliar</h3>
        <button (click)="cerrarZoom()" class="text-2xl font-bold text-gray-600 dark:text-gray-400">✕</button>
      </div>
      <div class="flex-1 flex items-center justify-center">
        <img [src]="imagenZoom" alt="Imagen" class="max-w-full max-h-full object-contain">
      </div>
    </div>
  </div>

  <!-- Modal Carga Mobile -->
  <div *ngIf="mostrarCargaImagenes" class="fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
    <div class="bg-white dark:bg-gray-800 rounded-t-2xl p-4 w-full">
      <h2 class="text-xl font-bold mb-3">⬆️ Cargar</h2>
      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Álbum</label>
        <input [(ngModel)]="albumNombre" type="text" placeholder="20251222"
               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Número inicial</label>
        <input [(ngModel)]="numeroInicio" type="number" min="1"
               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm">
      </div>
      <div class="mb-3">
        <input (change)="onFilesSelected($event)" type="file" multiple accept="image/*"
               class="w-full text-sm">
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button class="px-4 py-2 bg-gray-300 rounded-lg text-sm font-medium">
          Cancelar
        </button>
        <button [disabled]="!albumNombre || archivosCargados.length === 0"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium disabled:opacity-50">
          Subir
        </button>
      </div>
    </div>
  </div>
</div>

<!-- VISTA MOBILE -->
<div *ngIf="isMobile" class="space-y-4 p-3">
  <h1 class="text-2xl font-bold">🖼️ Galería</h1>
  <p class="text-gray-900 dark:text-white font-bold">Total: {{ productos.length }} imágenes</p>
</div>
