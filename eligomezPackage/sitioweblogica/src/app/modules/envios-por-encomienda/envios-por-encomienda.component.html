<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 p-6 transition-colors duration-300">
  <div class="max-w-7xl mx-auto space-y-6">
    <!-- Header con gradiente -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 dark:from-blue-800 dark:to-blue-900 text-white rounded-lg p-6 shadow-lg border-b-4 border-blue-800">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="text-3xl font-bold">📦 Envíos por Encomienda</h1>
          <p class="text-blue-100 dark:text-blue-200 text-sm mt-1">{{ diaEnvioHoy }}</p>
        </div>
        <div class="text-right bg-blue-700/50 px-4 py-2 rounded-lg">
          <p class="text-xs text-blue-100">Rango:</p>
          <p class="text-lg font-bold">{{ rangoFechas.inicio }} a {{ rangoFechas.fin }}</p>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="cargando" class="flex justify-center items-center py-12">
      <div class="text-center">
        <div class="inline-block animate-spin">
          <svg class="h-12 w-12 text-indigo-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mt-4">Cargando pedidos...</p>
      </div>
    </div>

    <!-- Mensaje vacío -->
    <div *ngIf="!cargando && mensajeVacio && encomiendasAgrupadas.length === 0" 
         class="bg-yellow-50 dark:bg-gray-700 border border-yellow-200 dark:border-gray-600 rounded-lg p-6 text-center transition-colors duration-300">
      <p class="text-yellow-800 dark:text-yellow-400 text-lg">{{ mensajeVacio }}</p>
    </div>

    <!-- Encomiendas agrupadas -->
    <div *ngIf="!cargando && encomiendasAgrupadas.length > 0" class="space-y-6">
      <!-- Resumen general -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
        <p class="text-gray-700 dark:text-gray-300 text-lg">
          <strong class="text-indigo-600">{{ encomiendasAgrupadas.length }}</strong> encomendista(s) | 
          <strong class="text-indigo-600">{{ totalPedidos }}</strong> pedidos totales
        </p>
      </div>

      <!-- Cada encomienda -->
      <div *ngFor="let encomienda of encomiendasAgrupadas" 
           class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
        
        <!-- Header de la encomienda con color por estado más común -->
        <div class="p-6" [ngClass]="obtenerColorHeader(encomienda.pedidos[0].estado)">
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h2 class="text-2xl font-bold">🚚 {{ encomienda.encomendista_nombre }}</h2>
              <p class="opacity-90 mt-1">{{ encomienda.conteo }} pedido(s) | Total: ${{ encomienda.total.toFixed(2) }}</p>
            </div>
            <button (click)="marcarEncomendaComoEnviada(encomienda)"
                    class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2 shadow">
              ✈️ Marcar Enviados
            </button>
          </div>
        </div>

        <!-- Lista de pedidos en grid -->
        <div class="p-6 bg-gray-50 dark:bg-gray-700/50">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div *ngFor="let pedido of encomienda.pedidos"
                 [ngClass]="obtenerColorBody(pedido.estado)"
                 class="rounded-lg p-4 shadow-sm hover:shadow-md transition">
              
              <!-- Header del pedido con color -->
              <div [ngClass]="obtenerColorHeader(pedido.estado)" 
                   class="rounded-t-lg -m-4 p-3 mb-3 flex items-center justify-between">
                <div class="flex items-center gap-2 text-white">
                  <span class="text-xl">{{ obtenerEmojiEstado(pedido.estado) }}</span>
                  <span class="font-bold text-sm">{{ formatearEstado(pedido.estado) }}</span>
                </div>
              </div>

              <!-- QR con Código (IMPORTANTE - PRIMERO) -->
              <div class="bg-white dark:bg-gray-800 rounded-lg border-2 border-purple-300 dark:border-purple-600 p-2 flex flex-col items-center justify-center mb-3">
                <img [src]="'https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=' + (pedido.codigo_pedido || pedido.id)" 
                     alt="QR" class="w-20 h-20 object-contain">
                <p class="text-xs font-bold text-gray-800 dark:text-white mt-2 text-center break-all">{{ pedido.codigo_pedido || pedido.id }}</p>
              </div>

              <!-- Foto del paquete -->
              <div *ngIf="pedido.foto_paquete" class="mb-3 rounded-lg overflow-hidden border-2 border-gray-300 dark:border-gray-600">
                <img [src]="pedido.foto_paquete" 
                     alt="Foto paquete"
                     class="w-full h-40 object-cover cursor-pointer hover:opacity-80 transition"
                     (click)="abrirZoom(pedido.foto_paquete)">
              </div>

              <!-- Cliente -->
              <p class="font-bold text-gray-900 dark:text-white truncate">{{ pedido.cliente_nombre }}</p>
              
              <!-- ID del pedido -->
              <p class="text-xs text-gray-600 dark:text-gray-400 font-mono">{{ pedido.codigo_pedido || pedido.id }}</p>

              <!-- Fecha de entrega -->
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-200 mt-2">
                📅 {{ pedido.fecha_entrega_programada | date: 'dd/MM/yyyy' }}
              </p>

              <!-- Total -->
              <p class="text-lg font-bold text-indigo-600 dark:text-indigo-400 mt-2">${{ (pedido.total || 0).toFixed(2) }}</p>

              <!-- Destino -->
              <p class="text-xs text-gray-700 dark:text-gray-300 mt-2 truncate" *ngIf="pedido.direccion_personalizada">
                📍 {{ pedido.direccion_personalizada }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Zoom de Foto -->
  <div *ngIf="mostrarZoom && imagenZoom" 
       class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"
       (click)="cerrarZoom()">
    <div class="relative max-w-2xl" (click)="$event.stopPropagation()">
      <img [src]="imagenZoom" alt="Zoom foto paquete" class="max-w-full max-h-screen rounded-lg shadow-2xl">
      <button (click)="cerrarZoom()" 
              class="absolute top-4 right-4 bg-white dark:bg-gray-800 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-200 dark:bg-gray-600 shadow-lg font-bold text-xl">
        ✕
      </button>
    </div>
  </div>
</div>
